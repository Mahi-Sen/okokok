<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Suite</title>
    <style>
        /* --- CSS remains largely the same as the previous version --- */
        /* (Minor adjustments might be included below for robustness) */
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6b8cae;
            --secondary-color-rgb: 107, 140, 174; /* RGB for opacity */
            --text-color: #333;
            --bg-color: #f5f5f5;
            --card-bg: rgba(255, 255, 255, 0.9); /* Slightly less transparent cards */
            --progress-bg: #e0e0e0;
            --completed-color: #4caf50;
            --early-completion-color: #2e7d32;
            --pomodoro-color: #e74c3c;
            --focus-color: #2ecc71;
            --ring-opacity: 0.25; /* Opacity for rings */
            --ring-glow-opacity: 0.1; /* Opacity for ring glow */
            --ring-number-opacity: 0.5;
        }

        .dark-theme {
            --primary-color: #5d8adb;
            --secondary-color: #7fa3d7;
            --secondary-color-rgb: 127, 163, 215; /* RGB for opacity */
            --text-color: #f0f0f0;
            --bg-color: #1a1a1a;
            --card-bg: rgba(40, 40, 40, 0.9); /* Slightly less transparent cards */
            --progress-bg: #444;
            --completed-color: #66bb6a;
            --early-completion-color: #388e3c;
            --pomodoro-color: #ff6b6b;
            --focus-color: #58d68d;
            --ring-opacity: 0.3;
            --ring-glow-opacity: 0.15;
            --ring-number-opacity: 0.6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        body { background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease; min-height: 100vh; padding: 20px; position: relative; overflow: hidden; }

        /* Eternal Time Rings Background */
        #background-rings-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .time-ring { position: absolute; border-style: solid; border-color: rgba(var(--secondary-color-rgb), var(--ring-opacity)); border-width: 2px; border-radius: 50%; box-shadow: 0 0 15px 3px rgba(var(--secondary-color-rgb), var(--ring-glow-opacity)); transform-origin: center center; will-change: transform; }
        .time-number { position: absolute; color: rgba(var(--secondary-color-rgb), var(--ring-number-opacity)); font-size: 10px; font-weight: bold; width: 14px; height: 14px; text-align: center; line-height: 14px; user-select: none; transform-origin: center center; }

        /* Keyframe Animations */
        @keyframes rotate-clockwise { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes rotate-counter-clockwise { from { transform: rotate(0deg); } to { transform: rotate(-360deg); } }

        /* Header Styles */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--card-bg); border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; position: relative; z-index: 10; }
        .owner-name { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
        .settings-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-color); transition: transform 0.3s ease; padding: 5px; }
        .settings-btn:hover { transform: rotate(90deg); }

        /* Settings Menu - Initially Hidden */
        .settings-menu { position: absolute; top: 60px; right: 20px; background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); padding: 10px 0; width: 200px; z-index: 1000; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.3s ease; }
        .settings-menu.active { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .settings-item { padding: 10px 20px; cursor: pointer; transition: background-color 0.2s; display: flex; align-items: center; }
        .settings-item:hover { background-color: var(--bg-color); }
        .settings-item i { margin-right: 10px; width: 20px; text-align: center; }

        /* Tabs */
        .tabs { display: flex; margin-bottom: 20px; background-color: var(--card-bg); border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); position: relative; z-index: 9; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; font-weight: bold; color: var(--text-color); }
        .tab.active { background-color: var(--primary-color); color: white; }

        /* Tab Content - Initially Hidden */
        .tab-content { display: none; position: relative; z-index: 8; }
        .tab-content.active { display: block; }

        /* Task Timeline Tracker Styles */
        .time-display { text-align: center; padding: 10px; background-color: var(--card-bg); border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .current-time { font-size: 1.2rem; }
        .ongoing-task { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; gap: 15px; overflow-y: auto; max-height: 60vh; position: relative; z-index: 5; }
        .task-item { background-color: var(--bg-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); cursor: move; user-select: none; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; position: relative; }
        .task-item.dragging { opacity: 0.8; background-color: rgba(var(--secondary-color-rgb), 0.2); transform: scale(1.02); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 1000; }
        .task-item .drag-handle { position: absolute; left: 5px; top: 50%; transform: translateY(-50%); cursor: move; padding: 10px; color: var(--secondary-color); opacity: 0.7; transition: opacity 0.2s; }
        .task-item:hover .drag-handle { opacity: 1; }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; margin-left: 25px; }
        .task-title { font-size: 1.2rem; font-weight: bold; margin-right: 10px; word-break: break-word; }
        .time-left { font-size: 1.1rem; color: var(--primary-color); white-space: nowrap; flex-shrink: 0; }
        .end-date { font-size: 0.85rem; color: var(--secondary-color); margin-top: -5px; margin-bottom: 10px; margin-left: 25px; }
        .progress-container { width: calc(100% - 25px); height: 18px; background-color: var(--progress-bg); border-radius: 9px; overflow: hidden; margin-bottom: 10px; position: relative; margin-left: 25px; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 9px; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--primary-color); font-weight: bold; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3); font-size: 0.75rem; transition: color 0.3s ease; pointer-events: none; }
        .task-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; margin-left: 25px; }
        .btn { padding: 7px 14px; border: none; border-radius: 5px; background-color: var(--primary-color); color: white; cursor: pointer; transition: background-color 0.3s; font-size: 0.9rem; }
        .btn:hover:not(:disabled) { background-color: var(--secondary-color); }
        .btn.secondary { background-color: var(--secondary-color); opacity: 0.9; }
        .btn.secondary:hover:not(:disabled) { background-color: var(--primary-color); opacity: 1; }
        .btn:disabled, .pomodoro-btn:disabled, .focus-btn:disabled { background-color: var(--progress-bg) !important; color: var(--secondary-color) !important; opacity: 0.7; cursor: not-allowed; box-shadow: none; }
        .past-tasks { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow-y: auto; max-height: 250px; margin-top: 20px; position: relative; z-index: 5; }
        .past-tasks-header { font-size: 1.2rem; margin-bottom: 15px; color: var(--primary-color); font-weight: bold; }
        .past-task-item { display: flex; justify-content: space-between; align-items: flex-start; padding: 10px 0; border-bottom: 1px solid var(--progress-bg); font-size: 0.95rem; }
        .past-task-item:last-child { border-bottom: none; }
        .past-task-name { font-weight: 500; margin-right: 10px; word-break: break-word; }
        .past-task-time { color: var(--secondary-color); white-space: nowrap; margin-left: 10px; font-size: 0.9rem; }
        .past-task-date { color: var(--secondary-color); font-size: 0.8rem; margin-top: 3px; }
        .early-completion { color: var(--early-completion-color); font-size: 0.75rem; margin-top: 3px; font-weight: bold; }
        .no-tasks-message { text-align: center; padding: 20px; color: var(--secondary-color); font-style: italic; }

        /* Floating Buttons */
        .theme-toggle, .add-task-btn { position: fixed; background-color: var(--primary-color); color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); z-index: 100; touch-action: none; user-select: none; }
        .theme-toggle { border-radius: 50%; width: 50px; height: 50px; }
        .add-task-btn { border-radius: 5px; padding: 10px 15px; font-size: 1.2rem; }
        .draggable { cursor: grab; }
        body.dragging-active { cursor: grabbing !important; user-select: none; }

        /* Modal Styles - Initially Hidden */
        .modal, .remarks-modal, .status-modal, .data-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); align-items: center; justify-content: center; z-index: 1100; padding: 15px; }
        .modal-content, .remarks-modal-content, .status-modal-content, .data-modal-content { background-color: var(--card-bg); padding: 25px; border-radius: 10px; width: 95%; max-width: 500px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-height: 90vh; overflow-y: auto; animation: fadeIn 0.3s ease-out; }
        .status-modal-content { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--progress-bg); }
        .modal-header h2 { font-size: 1.3rem; color: var(--primary-color); }
        .close-modal { background: none; border: none; font-size: 1.8rem; line-height: 1; cursor: pointer; color: var(--text-color); opacity: 0.7; transition: opacity 0.2s, transform 0.2s; padding: 0 5px; }
        .close-modal:hover { opacity: 1; transform: scale(1.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9rem; }
        input[type="text"], input[type="number"], input[type="datetime-local"], input[type="date"], select, textarea { width: 100%; padding: 10px; border: 1px solid var(--progress-bg); border-radius: 5px; background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(var(--secondary-color-rgb), 0.3); }
        .duration-input { position: relative; padding-bottom: 18px; }
        .duration-label { position: absolute; bottom: 0px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--secondary-color); white-space: nowrap; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 15px; border-top: 1px solid var(--progress-bg); }

        /* Task Method (in Task Modal) */
        .task-method-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .task-method-btn { flex: 1; padding: 10px; border: 1px solid var(--primary-color); background-color: var(--bg-color); color: var(--text-color); border-radius: 5px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .task-method-btn.active { background-color: var(--primary-color); color: white; }
        .task-method-content { display: none; animation: fadeIn 0.4s ease; }
        .task-method-content.active { display: block; }

        /* Celebration Overlay - Initially Hidden */
        .celebration-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); flex-direction: column; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.5s ease; }
        .celebration-overlay.active { display: flex; opacity: 1; }
        .celebration-text { font-size: clamp(2.5rem, 8vw, 4rem); font-weight: bold; color: #fff; text-align: center; margin-bottom: 2rem; text-shadow: 0 0 15px rgba(255, 255, 255, 0.8); animation: pulse 1.5s infinite ease-in-out; }
        .celebration-subtext { font-size: clamp(1rem, 4vw, 1.5rem); color: #eee; text-align: center; margin-bottom: 2rem; max-width: 80%; }
        .celebration-close { padding: 12px 25px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; font-size: 1.1rem; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .celebration-close:hover { background-color: var(--secondary-color); transform: scale(1.05); }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: #f00; opacity: 0; will-change: transform, top, opacity; pointer-events: none; }

        /* Data Modal Styles */
        .data-modal-content { max-width: 550px; }
        .data-actions { display: flex; flex-direction: column; gap: 10px; }
        .data-action-btn { padding: 10px 15px; border: none; border-radius: 5px; background-color: var(--primary-color); color: white; cursor: pointer; transition: background-color 0.3s; text-align: center; font-size: 1rem; }
        .data-action-btn:hover { background-color: var(--secondary-color); }
        .data-textarea { width: 100%; height: 150px; padding: 10px; margin-top: 15px; border: 1px solid var(--progress-bg); border-radius: 5px; background-color: var(--bg-color); color: var(--text-color); resize: vertical; font-family: monospace; font-size: 0.9rem; display: none; }
        #import-confirm-btn { display: none; margin-top: 10px; background-color: var(--completed-color); }
        #import-confirm-btn:hover { background-color: var(--early-completion-color); }

        /* Pomodoro Timer Styles */
        .pomodoro-container { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .pomodoro-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .pomodoro-title { font-size: 1.5rem; font-weight: bold; color: var(--pomodoro-color); }
        .pomodoro-timer { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .pomodoro-progress { position: relative; width: 200px; height: 200px; margin-bottom: 20px; }
        .pomodoro-progress svg { display: block; width: 100%; height: 100%; }
        .pomodoro-time { font-size: clamp(2rem, 10vw, 2.5rem); font-weight: bold; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1; color: var(--text-color); pointer-events: none; }
        #pomodoro-progress-indicator { transition: stroke-dashoffset 0.3s linear; }
        .pomodoro-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .pomodoro-btn { padding: 10px 20px; border: none; border-radius: 5px; background-color: var(--pomodoro-color); color: white; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; font-weight: 500; }
        .pomodoro-btn:hover:not(:disabled) { background-color: #c0392b; }
        .pomodoro-btn.secondary { background-color: var(--secondary-color); }
        .pomodoro-btn.secondary:hover:not(:disabled) { background-color: #5d7aa3; }
        .pomodoro-records { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow-x: auto; }
        .pomodoro-records-header { font-size: 1.2rem; margin-bottom: 15px; color: var(--pomodoro-color); font-weight: bold; }
        .pomodoro-records-table { width: 100%; border-collapse: collapse; min-width: 500px; }
        .pomodoro-records-table th, .pomodoro-records-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--progress-bg); white-space: nowrap; }
        .pomodoro-records-table td:last-child, .pomodoro-records-table th:last-child { white-space: normal; }
        .pomodoro-records-table th { font-weight: bold; color: var(--pomodoro-color); font-size: 0.9rem; text-transform: uppercase; }
        .pomodoro-status-btn { padding: 8px 15px; border: none; border-radius: 5px; background-color: var(--pomodoro-color); color: white; cursor: pointer; transition: background-color 0.3s; margin-top: 15px; display: inline-block; }
        .pomodoro-status-btn:hover { background-color: #c0392b; }

        /* Pomodoro Set Time Modal */
        .pomodoro-set-time { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .pomodoro-time-inputs { display: flex; gap: 15px; margin-bottom: 20px; }
        .pomodoro-time-input { display: flex; flex-direction: column; align-items: center; }
        .pomodoro-time-input input { width: 60px; text-align: center; font-size: 1.1rem; margin-bottom: 5px; }
        .pomodoro-time-input label { font-size: 0.85rem; color: var(--secondary-color); }
        #pomodoro-time-slider { width: 80%; max-width: 300px; cursor: pointer; margin-top: 10px; }

        /* Focus Time Styles */
        .focus-container { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .focus-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .focus-title { font-size: 1.5rem; font-weight: bold; color: var(--focus-color); }
        .focus-timer { display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .focus-time-display { font-size: clamp(2.5rem, 12vw, 3rem); font-weight: bold; margin-bottom: 20px; color: var(--focus-color); font-family: 'Consolas', 'Menlo', monospace; letter-spacing: 1px; }
        .focus-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .focus-btn { padding: 10px 20px; border: none; border-radius: 5px; background-color: var(--focus-color); color: white; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; font-weight: 500; }
        .focus-btn:hover:not(:disabled) { background-color: #27ae60; }
        .focus-btn.secondary { background-color: var(--secondary-color); }
        .focus-btn.secondary:hover:not(:disabled) { background-color: #5d7aa3; }
        .focus-task-input { width: 100%; max-width: 400px; margin: 0 auto 20px auto; }
        #focus-task-name { text-align: center; font-size: 1.1rem; }
        .focus-records { background-color: var(--card-bg); border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); overflow-x: auto; }
        .focus-records-header { font-size: 1.2rem; margin-bottom: 15px; color: var(--focus-color); font-weight: bold; }
        .focus-records-table { width: 100%; border-collapse: collapse; min-width: 550px; }
        .focus-records-table th, .focus-records-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--progress-bg); white-space: nowrap; }
        .focus-records-table td:nth-child(4), .focus-records-table th:nth-child(4), .focus-records-table td:last-child, .focus-records-table th:last-child { white-space: normal; }
        .focus-records-table th { font-weight: bold; color: var(--focus-color); font-size: 0.9rem; text-transform: uppercase; }
        .focus-status-btn { padding: 8px 15px; border: none; border-radius: 5px; background-color: var(--focus-color); color: white; cursor: pointer; transition: background-color 0.3s; margin-top: 15px; display: inline-block; }
        .focus-status-btn:hover { background-color: #27ae60; }

        /* Status Modal Styles */
        .status-tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid var(--progress-bg); }
        .status-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; transition: all 0.3s ease; color: var(--secondary-color); font-weight: 500; }
        .status-tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: bold; }
        .status-view { display: none; }
        .status-view.active { display: block; animation: fadeIn 0.4s ease; }
        .chart-container { width: 100%; min-height: 200px; height: auto; margin-bottom: 20px; padding: 15px; border: 1px solid var(--progress-bg); border-radius: 5px; background-color: var(--bg-color); }
        .chart-container h4 { margin-bottom: 15px; color: var(--primary-color); text-align: center; font-size: 1.1rem; }
        .date-range-selector { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
        .date-range-selector label { margin-bottom: 0; white-space: nowrap; font-size: 0.9rem; }
        .date-range-selector input { flex: 1; min-width: 120px; padding: 8px; }
        .date-range-selector .btn { padding: 8px 12px; }

        /* Remarks Modal Styles */
        .remarks-modal-content p { margin-bottom: 15px; font-size: 1.1rem; text-align: center; color: var(--text-color); }
        .remarks-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .remarks-option { padding: 15px; border: 1px solid var(--progress-bg); border-radius: 5px; text-align: center; cursor: pointer; transition: all 0.3s ease; background-color: var(--bg-color); font-weight: 500; }
        .remarks-option:hover { border-color: var(--secondary-color); background-color: rgba(var(--secondary-color-rgb), 0.1); }
        .remarks-option.selected { background-color: var(--primary-color); color: white; border-color: var(--primary-color); transform: scale(1.03); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* Animations */
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive Styles */
        @media (max-width: 768px) { body { padding: 15px; } header, .tabs { margin-bottom: 15px; } .modal-content, .status-modal-content { padding: 20px; } .chart-container { min-height: 180px; } .pomodoro-progress { width: 150px; height: 150px; } .pomodoro-records-table, .focus-records-table { font-size: 0.9rem; min-width: 0; } .pomodoro-records-table th, .pomodoro-records-table td, .focus-records-table th, .focus-records-table td { padding: 8px 6px; } }
        @media (max-width: 480px) { body { padding: 10px; overflow-x: hidden; } header { padding: 10px 15px; flex-wrap: wrap; gap: 5px; } .owner-name { font-size: 1.2rem; } .settings-menu { width: 180px; right: 10px; } .tabs { flex-direction: column; border-radius: 8px; } .tab { padding: 12px; border-bottom: 1px solid var(--progress-bg); } .tab:last-child { border-bottom: none; } .pomodoro-buttons, .focus-buttons { width: 90%; flex-direction: column; gap: 8px; } .pomodoro-btn, .focus-btn { width: 100%; } .modal-content { padding: 15px; } .modal-header h2 { font-size: 1.2rem; } .modal-footer { margin-top: 20px; padding-top: 10px; } .remarks-options { grid-template-columns: 1fr; } .date-range-selector { flex-direction: column; align-items: stretch; } .date-range-selector input, .date-range-selector .btn { width: 100%; flex: none; } .task-header, .progress-container, .task-actions, .end-date { margin-left: 20px; } .progress-container { width: calc(100% - 20px); } }

    </style>
</head>
<body>

    <!-- Background Rings Container (Empty, populated by JS) -->
    <div id="background-rings-container"></div>

    <!-- Header -->
    <header>
        <div class="owner-name">Productivity Suite</div>
        <button class="settings-btn" id="settings-btn" title="Settings">‚ò∞</button>
        <div class="settings-menu" id="settings-menu">
            <div class="settings-item" id="data-management-btn">
                <i>üìÅ</i> Data Management
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
        <div class="tab active" data-tab="tasks">TASKS</div>
        <div class="tab" data-tab="pomodoro">POMODORO</div>
        <div class="tab" data-tab="focus">FOCUS TIME</div>
    </div>

    <!-- Task Timeline Tracker Content -->
    <div class="tab-content active" id="tasks-content">
        <div class="time-display">
            <div class="current-time" id="current-time">Loading time...</div>
        </div>
        <main class="ongoing-task" id="ongoing-tasks-container">
            <div class="no-tasks-message" id="no-tasks-message">No active tasks. Add a task to get started!</div>
        </main>
        <section class="past-tasks">
            <div class="past-tasks-header">Completed Tasks</div>
            <div id="past-tasks-list"></div>
        </section>
    </div>

    <!-- Pomodoro Timer Content -->
    <div class="tab-content" id="pomodoro-content">
        <div class="pomodoro-container">
            <div class="pomodoro-header">
                <div class="pomodoro-title">POMODORO</div>
                <button class="btn" id="set-pomodoro-btn">Set New</button>
            </div>
            <div class="pomodoro-timer">
                <div class="pomodoro-progress">
                     <svg width="200" height="200" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="92" fill="none" stroke="var(--progress-bg)" stroke-width="8"/>
                        <circle cx="100" cy="100" r="92" fill="none" stroke="var(--pomodoro-color)" stroke-width="8" stroke-linecap="round"
                                id="pomodoro-progress-indicator" transform="rotate(-90 100 100)"
                                stroke-dasharray="578" stroke-dashoffset="578"/>
                    </svg>
                    <div class="pomodoro-time" id="pomodoro-time">25:00</div>
                </div>
                <div class="pomodoro-buttons">
                    <button class="pomodoro-btn" id="start-pomodoro-btn">Start</button>
                    <button class="pomodoro-btn secondary" id="pause-pomodoro-btn" disabled>Pause</button>
                    <button class="pomodoro-btn secondary" id="cancel-pomodoro-btn" disabled>Cancel</button>
                </div>
            </div>
        </div>
        <div class="pomodoro-records">
            <div class="pomodoro-records-header">Pomodoro Records</div>
            <table class="pomodoro-records-table" id="pomodoro-records-table">
                <thead><tr><th>Status</th><th>Start Time</th><th>End Time</th><th>Duration</th><th>Remark</th></tr></thead>
                <tbody id="pomodoro-records-body"></tbody>
            </table>
            <button class="pomodoro-status-btn" id="pomodoro-status-btn">STATUS</button>
        </div>
    </div>

    <!-- Focus Time Content -->
    <div class="tab-content" id="focus-content">
         <div class="focus-container">
            <div class="focus-header">
                <div class="focus-title">FOCUS TIME</div>
            </div>
            <div class="focus-timer">
                <div class="focus-time-display" id="focus-time-display">00:00:00</div>
                <div class="focus-buttons">
                    <button class="focus-btn" id="start-focus-btn">Start</button>
                    <button class="focus-btn secondary" id="pause-focus-btn" disabled>Pause</button>
                    <button class="focus-btn secondary" id="stop-focus-btn" disabled>Stop</button>
                </div>
                <div class="focus-task-input" id="focus-task-input">
                    <input type="text" id="focus-task-name" placeholder="üìù What are you focusing on?" required>
                </div>
            </div>
        </div>
        <div class="focus-records">
            <div class="focus-records-header">Focus Time Records</div>
            <table class="focus-records-table" id="focus-records-table">
                 <thead><tr><th>Status</th><th>Date</th><th>Duration</th><th>Focused On</th><th>Remark</th></tr></thead>
                <tbody id="focus-records-body"></tbody>
            </table>
            <button class="focus-status-btn" id="focus-status-btn">STATUS</button>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="task-modal"> <div class="modal-content"> <div class="modal-header"> <h2 id="modal-title">Add New Task</h2> <button class="close-modal" id="close-task-modal">√ó</button> </div> <form id="task-form"> <div class="form-group"> <label for="task-name">Task Name</label> <input type="text" id="task-name" required> </div> <div class="task-method-selector"> <button type="button" class="task-method-btn active" id="duration-method-btn">By Duration</button> <button type="button" class="task-method-btn" id="date-method-btn">By End Date</button> </div> <div class="task-method-content active" id="duration-method"> <div class="form-group"> <label>Duration</label> <div style="display: flex; gap: 10px; flex-wrap: wrap;"> <div class="duration-input" style="flex: 1 1 60px;"> <input type="number" id="task-years" placeholder="Y" min="0" max="200" value="0"> <div class="duration-label">Years</div> </div> <div class="duration-input" style="flex: 1 1 60px;"> <input type="number" id="task-days" placeholder="D" min="0" max="365" value="0"> <div class="duration-label">Days</div> </div> <div class="duration-input" style="flex: 1 1 60px;"> <input type="number" id="task-hours" placeholder="H" min="0" max="23" value="0"> <div class="duration-label">Hours</div> </div> <div class="duration-input" style="flex: 1 1 60px;"> <input type="number" id="task-minutes" placeholder="M" min="0" max="59" value="0"> <div class="duration-label">Minutes</div> </div> <div class="duration-input" style="flex: 1 1 60px;"> <input type="number" id="task-seconds" placeholder="S" min="0" max="59" value="0"> <div class="duration-label">Seconds</div> </div> </div> </div> </div> <div class="task-method-content" id="date-method"> <div class="form-group"> <label for="task-end-date">End Date and Time</label> <input type="datetime-local" id="task-end-date"> </div> </div> <input type="hidden" id="task-id"> <input type="hidden" id="task-method" value="duration"> <div class="modal-footer"> <button type="button" class="btn secondary" id="cancel-btn">Cancel</button> <button type="submit" class="btn" id="save-task-btn">Save Task</button> </div> </form> </div> </div>
    <div class="modal" id="pomodoro-set-modal"> <div class="modal-content"> <div class="modal-header"> <h2>Set Pomodoro Time</h2> <button class="close-modal" id="close-pomodoro-set-modal">√ó</button> </div> <div class="pomodoro-set-time"> <div class="pomodoro-time-inputs"> <div class="pomodoro-time-input"> <input type="number" id="pomodoro-hours" min="0" max="25" value="0"> <label>Hours</label> </div> <div class="pomodoro-time-input"> <input type="number" id="pomodoro-minutes" min="0" max="59" value="25"> <label>Minutes</label> </div> </div> <input type="range" id="pomodoro-time-slider" min="1" max="1559" value="25" step="1" style="width: 100%;"> </div> <div class="modal-footer"> <button type="button" class="btn secondary" id="cancel-pomodoro-set-btn">Cancel</button> <button type="button" class="btn" id="save-pomodoro-set-btn">OK</button> </div> </div> </div>
    <div class="remarks-modal" id="pomodoro-remarks-modal"> <div class="remarks-modal-content"> <div class="modal-header"> <h2>Session Complete</h2> <button class="close-modal" id="close-pomodoro-remarks-modal">√ó</button> </div> <p>How was your Pomodoro session?</p> <div class="remarks-options"> <div class="remarks-option" data-remark="üíØ Super Focused">üíØ Super Focused</div> <div class="remarks-option" data-remark="üò∂ Distracted">üò∂ Distracted</div> <div class="remarks-option" data-remark="üò¥ Felt Tired">üò¥ Felt Tired</div> <div class="remarks-option" data-remark="üòì Took Unexpected Break">üòì Took Unexpected Break</div> <div class="remarks-option" data-remark="üì¥ Got Interrupted">üì¥ Got Interrupted</div> <div class="remarks-option" data-remark="üßò Peaceful Session">üßò Peaceful Session</div> </div> <div class="modal-footer"> <button type="button" class="btn" id="save-pomodoro-remarks-btn">Save Remark</button> </div> </div> </div>
    <div class="status-modal" id="pomodoro-status-modal"> <div class="status-modal-content"> <div class="modal-header"> <h2>Pomodoro Status</h2> <button class="close-modal" id="close-pomodoro-status-modal">√ó</button> </div> <div class="date-range-selector"> <label>From:</label> <input type="date" id="pomodoro-start-date"> <label>To:</label> <input type="date" id="pomodoro-end-date"> <button class="btn" id="apply-pomodoro-date-range">Apply</button> </div> <div class="status-tabs"> <div class="status-tab active" data-view="pomodoro-daily">Daily Overview</div> <div class="status-tab" data-view="pomodoro-remarks">Remarks Breakdown</div> </div> <div class="status-view active" id="pomodoro-daily-view"> <div class="chart-container" id="pomodoro-daily-chart"></div> </div> <div class="status-view" id="pomodoro-remarks-view"> <div class="chart-container" id="pomodoro-remarks-chart"></div> </div> </div> </div>
    <div class="remarks-modal" id="focus-remarks-modal"> <div class="remarks-modal-content"> <div class="modal-header"> <h2>Session Complete</h2> <button class="close-modal" id="close-focus-remarks-modal">√ó</button> </div> <p>How was your Focus session?</p> <div class="remarks-options"> <div class="remarks-option" data-remark="üíØ Super Focused">üíØ Super Focused</div> <div class="remarks-option" data-remark="üò∂ Distracted">üò∂ Distracted</div> <div class="remarks-option" data-remark="üò¥ Felt Tired">üò¥ Felt Tired</div> <div class="remarks-option" data-remark="üòì Took Unexpected Break">üòì Took Unexpected Break</div> <div class="remarks-option" data-remark="üì¥ Got Interrupted">üì¥ Got Interrupted</div> <div class="remarks-option" data-remark="üßò Peaceful Session">üßò Peaceful Session</div> </div> <div class="modal-footer"> <button type="button" class="btn" id="save-focus-remarks-btn">Save Remark</button> </div> </div> </div>
    <div class="status-modal" id="focus-status-modal"> <div class="status-modal-content"> <div class="modal-header"> <h2>Focus Time Status</h2> <button class="close-modal" id="close-focus-status-modal">√ó</button> </div> <div class="date-range-selector"> <label>From:</label> <input type="date" id="focus-start-date"> <label>To:</label> <input type="date" id="focus-end-date"> <button class="btn" id="apply-focus-date-range">Apply</button> </div> <div class="status-tabs"> <div class="status-tab active" data-view="focus-daily">Daily Overview</div> <div class="status-tab" data-view="focus-remarks">Remarks Breakdown</div> </div> <div class="status-view active" id="focus-daily-view"> <div class="chart-container" id="focus-daily-chart"></div> </div> <div class="status-view" id="focus-remarks-view"> <div class="chart-container" id="focus-remarks-chart"></div> </div> </div> </div>
    <div class="data-modal" id="data-modal"> <div class="data-modal-content"> <div class="modal-header"> <h2 id="data-modal-title">Data Management</h2> <button class="close-modal" id="close-data-modal">√ó</button> </div> <div class="data-actions"> <button class="data-action-btn" id="export-json-btn">Export as JSON</button> <button class="data-action-btn" id="import-json-btn">Import from JSON</button> <textarea class="data-textarea" id="data-textarea" placeholder="Paste your JSON data here for import"></textarea> <button class="data-action-btn" id="import-confirm-btn">Confirm Import</button> </div> </div> </div>
    <div class="celebration-overlay" id="celebration-overlay"> <div class="celebration-text" id="celebration-text">CONGRATULATIONS!</div> <div class="celebration-subtext" id="celebration-subtext">Task completed!</div> <button class="celebration-close" id="celebration-close">Continue</button> </div>

    <!-- Floating Buttons -->
    <button class="theme-toggle draggable" id="theme-toggle" title="Toggle Theme">üåì</button>
    <button class="add-task-btn draggable" id="add-task-btn" title="Add New Task">+</button>


    <script>
        // DOM Elements
        const timeRingsContainer = document.getElementById('background-rings-container');
        const currentTimeEl = document.getElementById('current-time');
        const ongoingTasksContainerEl = document.getElementById('ongoing-tasks-container');
        const noTasksMessageEl = document.getElementById('no-tasks-message');
        const pastTasksListEl = document.getElementById('past-tasks-list');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const addTaskBtn = document.getElementById('add-task-btn');
        // Task Modal
        const taskModal = document.getElementById('task-modal');
        const closeTaskModalBtn = taskModal.querySelector('.close-modal'); // Scope selectors
        const cancelBtn = document.getElementById('cancel-btn');
        const taskForm = document.getElementById('task-form');
        const modalTitle = document.getElementById('modal-title');
        const taskNameInput = document.getElementById('task-name');
        const taskYearsInput = document.getElementById('task-years');
        const taskDaysInput = document.getElementById('task-days');
        const taskHoursInput = document.getElementById('task-hours');
        const taskMinutesInput = document.getElementById('task-minutes');
        const taskSecondsInput = document.getElementById('task-seconds');
        const taskEndDateInput = document.getElementById('task-end-date');
        const taskIdInput = document.getElementById('task-id');
        const taskMethodInput = document.getElementById('task-method');
        const durationMethodBtn = document.getElementById('duration-method-btn');
        const dateMethodBtn = document.getElementById('date-method-btn');
        const durationMethod = document.getElementById('duration-method');
        const dateMethod = document.getElementById('date-method');
        // Celebration
        const celebrationOverlay = document.getElementById('celebration-overlay');
        const celebrationText = document.getElementById('celebration-text');
        const celebrationSubtext = document.getElementById('celebration-subtext');
        const celebrationClose = document.getElementById('celebration-close');
        // Settings Menu
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const dataManagementBtn = document.getElementById('data-management-btn');
        // Data Modal
        const dataModal = document.getElementById('data-modal');
        const closeDataModalBtn = dataModal.querySelector('.close-modal');
        const exportJsonBtn = document.getElementById('export-json-btn');
        const importJsonBtn = document.getElementById('import-json-btn');
        const dataTextarea = document.getElementById('data-textarea');
        const importConfirmBtn = document.getElementById('import-confirm-btn');
        // Tabs
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        // Pomodoro Elements
        const pomodoroTimeEl = document.getElementById('pomodoro-time');
        const startPomodoroBtn = document.getElementById('start-pomodoro-btn');
        const pausePomodoroBtn = document.getElementById('pause-pomodoro-btn');
        const cancelPomodoroBtn = document.getElementById('cancel-pomodoro-btn');
        const setPomodoroBtn = document.getElementById('set-pomodoro-btn');
        const pomodoroSetModal = document.getElementById('pomodoro-set-modal');
        const closePomodoroSetModal = pomodoroSetModal.querySelector('.close-modal');
        const cancelPomodoroSetBtn = document.getElementById('cancel-pomodoro-set-btn');
        const savePomodoroSetBtn = document.getElementById('save-pomodoro-set-btn');
        const pomodoroHoursInput = document.getElementById('pomodoro-hours');
        const pomodoroMinutesInput = document.getElementById('pomodoro-minutes');
        const pomodoroTimeSlider = document.getElementById('pomodoro-time-slider');
        const pomodoroRecordsBody = document.getElementById('pomodoro-records-body');
        const pomodoroRemarksModal = document.getElementById('pomodoro-remarks-modal');
        const closePomodoroRemarksModal = pomodoroRemarksModal.querySelector('.close-modal');
        const savePomodoroRemarksBtn = document.getElementById('save-pomodoro-remarks-btn');
        const pomodoroStatusBtn = document.getElementById('pomodoro-status-btn');
        const pomodoroStatusModal = document.getElementById('pomodoro-status-modal');
        const closePomodoroStatusModal = pomodoroStatusModal.querySelector('.close-modal');
        const pomodoroStartDate = document.getElementById('pomodoro-start-date');
        const pomodoroEndDate = document.getElementById('pomodoro-end-date');
        const applyPomodoroDateRange = document.getElementById('apply-pomodoro-date-range');
        const pomodoroStatusTabs = pomodoroStatusModal.querySelectorAll('.status-tab');
        const pomodoroViews = pomodoroStatusModal.querySelectorAll('.status-view');
        const pomodoroDailyChart = document.getElementById('pomodoro-daily-chart');
        const pomodoroRemarksChart = document.getElementById('pomodoro-remarks-chart');
        // Focus Time Elements
        const focusTimeDisplay = document.getElementById('focus-time-display');
        const startFocusBtn = document.getElementById('start-focus-btn');
        const pauseFocusBtn = document.getElementById('pause-focus-btn');
        const stopFocusBtn = document.getElementById('stop-focus-btn');
        const focusTaskInput = document.getElementById('focus-task-input');
        const focusTaskName = document.getElementById('focus-task-name');
        const focusRecordsBody = document.getElementById('focus-records-body');
        const focusRemarksModal = document.getElementById('focus-remarks-modal');
        const closeFocusRemarksModal = focusRemarksModal.querySelector('.close-modal');
        const saveFocusRemarksBtn = document.getElementById('save-focus-remarks-btn');
        const focusStatusBtn = document.getElementById('focus-status-btn');
        const focusStatusModal = document.getElementById('focus-status-modal');
        const closeFocusStatusModal = focusStatusModal.querySelector('.close-modal');
        const focusStartDate = document.getElementById('focus-start-date');
        const focusEndDate = document.getElementById('focus-end-date');
        const applyFocusDateRange = document.getElementById('apply-focus-date-range');
        const focusStatusTabs = focusStatusModal.querySelectorAll('.status-tab');
        const focusViews = focusStatusModal.querySelectorAll('.status-view');
        const focusDailyChart = document.getElementById('focus-daily-chart');
        const focusRemarksChart = document.getElementById('focus-remarks-chart');
        // Remarks Options
        const allRemarksOptions = document.querySelectorAll('.remarks-option');

        // App State
        let state = { /* ... (same state object as before) ... */
            currentTasks: [], pastTasks: [], isEditing: false, darkTheme: false,
            buttonPositions: { themeToggle: { x: window.innerWidth - 70, y: window.innerHeight - 70 }, addTask: { x: window.innerWidth - 70, y: window.innerHeight - 130 } },
            pomodoro: { timer: null, isRunning: false, isPaused: false, totalSeconds: 25 * 60, remainingSeconds: 25 * 60, startTime: null, endTime: null, records: [], currentRecord: null },
            focus: { timer: null, isRunning: false, isPaused: false, elapsedSeconds: 0, startTime: null, endTime: null, records: [], currentRecord: null }
        };


        // --- Ring Generation Function ---
        function createTimeRings() {
            const container = timeRingsContainer;
            if (!container) return;

            const containerWidth = window.innerWidth;
            const containerHeight = window.innerHeight;
            const centerX = containerWidth / 2;
            const centerY = containerHeight / 2;

            container.innerHTML = ''; // Clear previous rings

            // --- Ring Control Parameters ---
            const ringCount = 6;         // <<< Change NUMBER OF RINGS here
            const baseRadius = 100;      // <<< Change size of the INNERMOST ring here
            const ringSpacing = 90;      // <<< Change DISTANCE BETWEEN RINGS here
            const numberOffset = 15;     // How far inside the ring border numbers are placed
            // --- End of Ring Control Parameters ---

            for (let i = 1; i <= ringCount; i++) {
                const radius = baseRadius + ((i-1) * ringSpacing);
                if (radius > Math.max(containerWidth, containerHeight) * 0.8) break; // Stop if rings get too big

                const ring = document.createElement('div');
                ring.className = 'time-ring';
                ring.style.width = `${radius * 2}px`;
                ring.style.height = `${radius * 2}px`;
                ring.style.left = `${centerX - radius}px`;
                ring.style.top = `${centerY - radius}px`;

                // Animation: Speed is controlled here (longer duration = slower rotation)
                const rotationDirection = i % 2 === 0 ? 'rotate-clockwise' : 'rotate-counter-clockwise';
                const rotationSpeed = 20 + (i * 15); // <<< Change calculation for rotation SPEED here
                ring.style.animation = `${rotationDirection} ${rotationSpeed}s infinite linear`;

                // Add numbers
                const numberCountOnRing = 12; // <<< Change how many NUMBERS (1-12 cycle) appear ON EACH ring here
                const angleStep = (2 * Math.PI) / numberCountOnRing;

                for (let j = 0; j < numberCountOnRing; j++) {
                    const angle = j * angleStep;
                    const number = (j % 12) + 1; // Cycle through 1-12

                    const numberEl = document.createElement('div');
                    numberEl.className = 'time-number';
                    numberEl.textContent = number;

                    const numRadius = radius - numberOffset;
                    const x = numRadius * Math.cos(angle - Math.PI / 2);
                    const y = numRadius * Math.sin(angle - Math.PI / 2);

                    numberEl.style.transform = `translate(calc(${x}px + ${radius}px - 7px), calc(${y}px + ${radius}px - 7px))`;

                    ring.appendChild(numberEl);
                }
                container.appendChild(ring);
            }
        }

        // Debounce function
        function debounce(func, wait) { /* ... (same debounce function) ... */
             let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); };
         }
        const debouncedCreateRings = debounce(createTimeRings, 250);


        // Initialize app
        function init() {
            loadFromLocalStorage();
            document.body.classList.toggle('dark-theme', state.darkTheme);

            createTimeRings(); // Create initial rings
            window.addEventListener('resize', debouncedCreateRings); // Recreate on resize

            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            setInterval(updateTasksProgress, 1000); // Keep interval for progress update
            renderTasks(); // Initial render
            renderPastTasks(); // Initial render

            // Date Picker Setup
            const today = new Date(); const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate() - 7);
            const todayStr = formatDateForInput(today); const oneWeekAgoStr = formatDateForInput(oneWeekAgo);
            pomodoroStartDate.value = oneWeekAgoStr; pomodoroEndDate.value = todayStr; focusStartDate.value = oneWeekAgoStr; focusEndDate.value = todayStr;
            pomodoroStartDate.max = todayStr; pomodoroEndDate.max = todayStr; focusStartDate.max = todayStr; focusEndDate.max = todayStr;
            pomodoroEndDate.min = pomodoroStartDate.value; focusEndDate.min = focusStartDate.value;
            pomodoroStartDate.addEventListener('change', () => pomodoroEndDate.min = pomodoroStartDate.value);
            focusStartDate.addEventListener('change', () => focusEndDate.min = focusStartDate.value);

             // Position buttons after initial layout
             requestAnimationFrame(() => {
                 positionButton(themeToggleBtn, state.buttonPositions.themeToggle);
                 positionButton(addTaskBtn, state.buttonPositions.addTask);
             });

            makeDraggable(themeToggleBtn, 'themeToggle');
            makeDraggable(addTaskBtn, 'addTask');

            // Init Timers UI
            updatePomodoroDisplay();
            renderPomodoroRecords();
            updateFocusDisplay();
            renderFocusRecords();
            resetTimerButtons(); // Set initial button states

            setupEventListeners();
        }

         // Setup all event listeners
         function setupEventListeners() {
             // ... (Keep all previous listeners from the last version) ...
             themeToggleBtn.addEventListener('click', toggleTheme);
             addTaskBtn.addEventListener('click', () => openTaskModal(false));
             closeTaskModalBtn.addEventListener('click', closeTaskModal); // Use scoped var
             cancelBtn.addEventListener('click', closeTaskModal);
             taskForm.addEventListener('submit', saveTask);
             celebrationClose.addEventListener('click', () => { celebrationOverlay.classList.remove('active'); celebrationOverlay.style.display = 'none'; });
             durationMethodBtn.addEventListener('click', () => switchTaskMethod('duration'));
             dateMethodBtn.addEventListener('click', () => switchTaskMethod('date'));
             settingsBtn.addEventListener('click', toggleSettingsMenu);
             dataManagementBtn.addEventListener('click', function() { openDataModal(); settingsMenu.classList.remove('active'); });
             closeDataModalBtn.addEventListener('click', closeDataModal);
             exportJsonBtn.addEventListener('click', exportAsJson);
             importJsonBtn.addEventListener('click', showImportTextarea);
             importConfirmBtn.addEventListener('click', importFromJson);
             document.addEventListener('click', function(e) { if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target) && settingsMenu.classList.contains('active')) { settingsMenu.classList.remove('active'); } });
             tabs.forEach(tab => { tab.addEventListener('click', () => { switchTab(tab.getAttribute('data-tab')); }); });
             startPomodoroBtn.addEventListener('click', startPomodoro);
             pausePomodoroBtn.addEventListener('click', togglePausePomodoro);
             cancelPomodoroBtn.addEventListener('click', cancelPomodoro);
             setPomodoroBtn.addEventListener('click', openPomodoroSetModal);
             closePomodoroSetModal.addEventListener('click', closePomodoroSetModalFunc);
             cancelPomodoroSetBtn.addEventListener('click', closePomodoroSetModalFunc);
             savePomodoroSetBtn.addEventListener('click', savePomodoroTime);
             pomodoroTimeSlider.addEventListener('input', updatePomodoroTimeFromSlider);
             pomodoroHoursInput.addEventListener('input', updatePomodoroTimeFromInputs);
             pomodoroMinutesInput.addEventListener('input', updatePomodoroTimeFromInputs);
             closePomodoroRemarksModal.addEventListener('click', closePomodoroRemarksModalFunc);
             savePomodoroRemarksBtn.addEventListener('click', savePomodoroRemarks);
             pomodoroStatusBtn.addEventListener('click', openPomodoroStatusModal);
             closePomodoroStatusModal.addEventListener('click', closePomodoroStatusModalFunc);
             applyPomodoroDateRange.addEventListener('click', updatePomodoroCharts);
             pomodoroStatusTabs.forEach(tab => { tab.addEventListener('click', () => { switchStatusView(tab.getAttribute('data-view'), pomodoroStatusTabs, pomodoroViews); }); });
             startFocusBtn.addEventListener('click', startFocus);
             pauseFocusBtn.addEventListener('click', togglePauseFocus);
             stopFocusBtn.addEventListener('click', stopFocus);
             closeFocusRemarksModal.addEventListener('click', closeFocusRemarksModalFunc);
             saveFocusRemarksBtn.addEventListener('click', saveFocusRemarks);
             focusStatusBtn.addEventListener('click', openFocusStatusModal);
             closeFocusStatusModal.addEventListener('click', closeFocusStatusModalFunc);
             applyFocusDateRange.addEventListener('click', updateFocusCharts);
             focusStatusTabs.forEach(tab => { tab.addEventListener('click', () => { switchStatusView(tab.getAttribute('data-view'), focusStatusTabs, focusViews); }); });
             allRemarksOptions.forEach(option => { option.addEventListener('click', () => { const pM = option.closest('.remarks-modal'); if (pM) { pM.querySelectorAll('.remarks-option').forEach(o => o.classList.remove('selected')); option.classList.add('selected'); } }); });
             ongoingTasksContainerEl.addEventListener('dragover', (e) => { e.preventDefault(); const dE = document.querySelector('.task-item.dragging'); if (!dE) return; const aE = getDragAfterElement(ongoingTasksContainerEl, e.clientY); const cR = ongoingTasksContainerEl.getBoundingClientRect(); const eT = 50; if (e.clientY < cR.top + eT) ongoingTasksContainerEl.scrollTop -= 10; else if (e.clientY > cR.bottom - eT) ongoingTasksContainerEl.scrollTop += 10; if (aE == null) ongoingTasksContainerEl.appendChild(dE); else ongoingTasksContainerEl.insertBefore(dE, aE); });
         }

        // --- Core Logic Functions ---

        function switchTaskMethod(method) {
            const isActive = method === 'duration';
            durationMethodBtn.classList.toggle('active', isActive);
            dateMethodBtn.classList.toggle('active', !isActive);
            durationMethod.classList.toggle('active', isActive);
            dateMethod.classList.toggle('active', !isActive);
            taskMethodInput.value = method;
            if (taskEndDateInput) taskEndDateInput.required = !isActive;
        }
        function switchTab(tabId) {
            tabs.forEach(tab => tab.classList.toggle('active', tab.getAttribute('data-tab') === tabId));
            tabContents.forEach(content => content.classList.toggle('active', content.id === `${tabId}-content`));
        }
        function positionButton(button, position) {
             if (!button) return;
             let currentPos = position;
             if (!currentPos || typeof currentPos.x !== 'number' || typeof currentPos.y !== 'number') {
                 const defaults = { themeToggle: { x: window.innerWidth - 70, y: window.innerHeight - 70 }, addTask: { x: window.innerWidth - 70, y: window.innerHeight - 130 } };
                 const type = button.id.includes('theme') ? 'themeToggle' : 'addTask';
                 currentPos = defaults[type];
             }
             const buttonWidth = button.offsetWidth || 50; const buttonHeight = button.offsetHeight || 50;
             const padding = 10;
             const maxX = window.innerWidth - buttonWidth - padding; const maxY = window.innerHeight - buttonHeight - padding;
             const constrainedX = Math.max(padding, Math.min(currentPos.x, maxX)); const constrainedY = Math.max(padding, Math.min(currentPos.y, maxY));
             button.style.left = `${constrainedX}px`; button.style.top = `${constrainedY}px`;
         }
        function makeDraggable(button, buttonType) { /* ... (same complex draggable logic) ... */
            let isDragging = false, offsetX, offsetY, hasMoved = false;
            const startDrag = (clientX, clientY) => { isDragging = true; hasMoved = false; offsetX = clientX - button.getBoundingClientRect().left; offsetY = clientY - button.getBoundingClientRect().top; button.style.cursor = 'grabbing'; document.body.classList.add('dragging-active'); };
            const drag = (clientX, clientY) => { if (!isDragging) return; if (!hasMoved) hasMoved = true; const x = clientX - offsetX; const y = clientY - offsetY; const buttonWidth = button.offsetWidth; const buttonHeight = button.offsetHeight; const padding = 10; const maxX = window.innerWidth - buttonWidth - padding; const maxY = window.innerHeight - buttonHeight - padding; const constrainedX = Math.max(padding, Math.min(x, maxX)); const constrainedY = Math.max(padding, Math.min(y, maxY)); button.style.left = `${constrainedX}px`; button.style.top = `${constrainedY}px`; };
            const endDrag = () => { if (!isDragging) return; isDragging = false; button.style.cursor = 'grab'; document.body.classList.remove('dragging-active'); const rect = button.getBoundingClientRect(); state.buttonPositions[buttonType] = { x: rect.left, y: rect.top }; saveToLocalStorage(); };
            button.addEventListener('mousedown', (e) => { if (e.button === 0) { startDrag(e.clientX, e.clientY); e.preventDefault(); } });
            document.addEventListener('mousemove', (e) => { if (isDragging) drag(e.clientX, e.clientY); });
            document.addEventListener('mouseup', (e) => { if (e.button === 0 && isDragging) endDrag(); });
            button.addEventListener('click', (e) => { if (hasMoved) { e.preventDefault(); e.stopPropagation(); } }, true);
            button.addEventListener('touchstart', (e) => { if (e.touches.length === 1) { const touch = e.touches[0]; startDrag(touch.clientX, touch.clientY); } }, { passive: true });
            document.addEventListener('touchmove', (e) => { if (isDragging && e.touches.length === 1) { const touch = e.touches[0]; drag(touch.clientX, touch.clientY); e.preventDefault(); } }, { passive: false });
            document.addEventListener('touchend', (e) => { if (isDragging) endDrag(); });
            document.addEventListener('touchcancel', (e) => { if (isDragging) endDrag(); });
        }
        function updateCurrentTime() {
            const now = new Date(); const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }; currentTimeEl.textContent = now.toLocaleTimeString('en-US', options);
        }
        function updateTasksProgress() { /* ... (same logic, relies on completeTask for removal) ... */
             if (!state.currentTasks || state.currentTasks.length === 0) return; const now = new Date();
             state.currentTasks.forEach(task => { // Iterate, don't filter here
                 const taskEl = document.getElementById(`task-${task.id}`); if (!task || !task.startTime || typeof task.durationMs !== 'number') return;
                 const startTime = new Date(task.startTime); if (isNaN(startTime)) return;
                 const elapsedMs = now - startTime; const totalMs = task.durationMs; const remainingMs = Math.max(0, totalMs - elapsedMs);
                 const progressPercent = totalMs > 0 ? Math.min(100, (elapsedMs / totalMs) * 100) : 0;
                 if (taskEl) { /* ... (update DOM elements) ... */
                     const progressEl = taskEl.querySelector('.progress-bar'); const progressTextEl = taskEl.querySelector('.progress-text'); const timeLeftEl = taskEl.querySelector('.time-left');
                     if(progressEl) progressEl.style.width = `${progressPercent.toFixed(1)}%`;
                     if(progressTextEl) { progressTextEl.textContent = `${progressPercent.toFixed(1)}%`; progressTextEl.style.color = progressPercent >= 50 ? 'white' : 'var(--primary-color)'; }
                     if(timeLeftEl) { const y=Math.floor(remainingMs/(365*864e5)), d=Math.floor((remainingMs%(365*864e5))/864e5), h=Math.floor((remainingMs%864e5)/36e5), m=Math.floor((remainingMs%36e5)/6e4), s=Math.floor((remainingMs%6e4)/1e3); let txt=''; if(y>0)txt+=`${y}y `; if(d>0)txt+=`${d}d `; if(h>0||y>0||d>0)txt+=`${h.toString().padStart(2,'0')}h `; if(m>0||h>0||y>0||d>0)txt+=`${m.toString().padStart(2,'0')}m `; txt+=`${s.toString().padStart(2,'0')}s`; timeLeftEl.textContent = txt.trim(); }
                 }
                 if (remainingMs <= 0) {
                     completeTask(task.id, false); // Complete the task
                 }
             });
         }
        function toggleNoTasksMessage() {
            noTasksMessageEl.style.display = (!state.currentTasks || state.currentTasks.length === 0) ? 'block' : 'none';
        }
        function renderTasks() {
            const taskElements = ongoingTasksContainerEl.querySelectorAll('.task-item'); taskElements.forEach(el => el.remove());
            toggleNoTasksMessage();
            if (state.currentTasks && state.currentTasks.length > 0) {
                state.currentTasks.forEach(task => { /* ... (same rendering logic as before) ... */
                    if (!task || !task.startTime || typeof task.durationMs !== 'number') return;
                    const taskEl = document.createElement('div'); taskEl.className = 'task-item'; taskEl.id = `task-${task.id}`; taskEl.draggable = true;
                    const startTime = new Date(task.startTime); if (isNaN(startTime)) return;
                    const endDate = new Date(startTime.getTime() + task.durationMs); const endDateFormatted = endDate.toLocaleString('en-US', { weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit' });
                    taskEl.innerHTML = `<div class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</div> <div class="task-header"> <div class="task-title">${task.name || 'Untitled Task'}</div> <div class="time-left">--:--:--</div> </div> <div class="end-date">Ends on: ${endDateFormatted}</div> <div class="progress-container"> <div class="progress-bar" style="width: 0%"></div> <div class="progress-text">0%</div> </div> <div class="task-actions"> <button class="btn edit-task-btn" data-id="${task.id}" title="Edit Task">Edit</button> <button class="btn complete-task-btn" data-id="${task.id}" title="Mark as Complete">Complete</button> </div>`;
                    taskEl.addEventListener('dragstart', handleDragStart); taskEl.addEventListener('dragend', handleDragEnd);
                    ongoingTasksContainerEl.appendChild(taskEl);
                    taskEl.querySelector('.edit-task-btn').addEventListener('click', () => openTaskModal(true, task.id));
                    taskEl.querySelector('.complete-task-btn').addEventListener('click', () => completeTask(task.id, true));
                });
                updateTasksProgress(); // Call immediately after rendering
            }
        }
        function handleDragStart(e) { this.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', this.id); }
        function handleDragEnd() { this.classList.remove('dragging'); updateTaskOrder(); }
        function getDragAfterElement(container, y) { const d=[...container.querySelectorAll('.task-item:not(.dragging)')]; return d.reduce((c,ch)=>{const b=ch.getBoundingClientRect(),o=y-b.top-b.height/2; if(o<0&&o>c.offset)return{offset:o,element:ch};else return c},{offset:Number.NEGATIVE_INFINITY}).element;}
        function updateTaskOrder() { const ids=[...ongoingTasksContainerEl.querySelectorAll('.task-item')].map(el=>el.id); state.currentTasks.sort((a,b)=>ids.indexOf(`task-${a.id}`)-ids.indexOf(`task-${b.id}`)); saveToLocalStorage(); console.log("Task order updated.");}
        function openTaskModal(isEditing, taskId = null) { /* ... (same logic as before) ... */
             state.isEditing = isEditing; modalTitle.textContent = isEditing ? 'Edit Task' : 'Add New Task';
             taskForm.reset(); taskYearsInput.value=0; taskDaysInput.value=0; taskHoursInput.value=0; taskMinutesInput.value=0; taskSecondsInput.value=0; taskIdInput.value=''; switchTaskMethod('duration');
             const defaultEndDate=new Date(); defaultEndDate.setDate(defaultEndDate.getDate()+1); taskEndDateInput.value=formatDateTimeForInput(defaultEndDate); taskEndDateInput.required = false;
             if (isEditing && taskId) { const task=state.currentTasks.find(t=>t.id===taskId); if(task){ taskNameInput.value=task.name; taskIdInput.value=taskId; const d=task.durationMs; taskYearsInput.value=Math.floor(d/(365*864e5)); taskDaysInput.value=Math.floor((d%(365*864e5))/864e5); taskHoursInput.value=Math.floor((d%864e5)/36e5); taskMinutesInput.value=Math.floor((d%36e5)/6e4); taskSecondsInput.value=Math.floor((d%6e4)/1e3); const sT=new Date(task.startTime); if(!isNaN(sT)){const eD=new Date(sT.getTime()+d); taskEndDateInput.value=formatDateTimeForInput(eD);}else{taskEndDateInput.value=formatDateTimeForInput(defaultEndDate);} switchTaskMethod('duration'); } else { state.isEditing=false; modalTitle.textContent='Add New Task'; } }
             taskModal.style.display='flex'; requestAnimationFrame(()=>taskNameInput.focus());
        }
        function formatDateTimeForInput(date) { if(!(date instanceof Date)||isNaN(date))return''; const y=date.getFullYear(), M=String(date.getMonth()+1).padStart(2,'0'), D=String(date.getDate()).padStart(2,'0'), H=String(date.getHours()).padStart(2,'0'), m=String(date.getMinutes()).padStart(2,'0'); return`${y}-${M}-${D}T${H}:${m}`; }
        function closeTaskModal() { taskModal.style.display = 'none'; }
        function saveTask(e) { /* ... (same logic as before) ... */
             e.preventDefault(); const name=taskNameInput.value.trim(); if(!name){alert('Task Name cannot be empty.');taskNameInput.focus();return;} let durationMs=0; let taskStartTime=new Date();
             if (taskMethodInput.value==='duration'){ const y=parseInt(taskYearsInput.value)||0, d=parseInt(taskDaysInput.value)||0, h=parseInt(taskHoursInput.value)||0, m=parseInt(taskMinutesInput.value)||0, s=parseInt(taskSecondsInput.value)||0; durationMs=(y*365*864e5+d*864e5+h*36e5+m*6e4+s*1e3); if(durationMs<=0){alert('Please set a duration greater than zero.');return;} } else { const edv=taskEndDateInput.value; if(!edv){alert('Please select an end date and time.');taskEndDateInput.focus();return;} const endDate=new Date(edv); if(isNaN(endDate)){alert('Invalid end date selected.');taskEndDateInput.focus();return;} durationMs=endDate-taskStartTime; if(durationMs<=0){alert('End date must be in the future.');taskEndDateInput.focus();return;} }
             if (state.isEditing&&taskIdInput.value){ const taskId=parseInt(taskIdInput.value); const taskIndex=state.currentTasks.findIndex(t=>t.id===taskId); if(taskIndex!==-1){ state.currentTasks[taskIndex]={...state.currentTasks[taskIndex], name:name, durationMs:durationMs}; } } else { const newTask={id:Date.now(), name, durationMs, startTime:taskStartTime.toISOString(), completed:false}; state.currentTasks.push(newTask); }
             renderTasks(); saveToLocalStorage(); closeTaskModal();
        }

        // *** CORRECTED completeTask Function ***
        function completeTask(taskId, isManualCompletion) {
            const taskIndex = state.currentTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return; // Already removed or doesn't exist

            const task = state.currentTasks[taskIndex];
            if (!task || !task.startTime || typeof task.durationMs !== 'number') return;

            const now = new Date();
            const startTime = new Date(task.startTime);
            if (isNaN(startTime)) return;

            const actualDurationMs = now - startTime;
            const scheduledEndTime = startTime.getTime() + task.durationMs;
            const earlyCompletionMs = isManualCompletion && (now.getTime() < scheduledEndTime)
                                      ? scheduledEndTime - now.getTime()
                                      : 0;

            const completedTask = {
                id: task.id, name: task.name, durationMs: task.durationMs,
                actualDurationMs: Math.max(0, actualDurationMs), completedAt: now.toISOString(),
                completed: true, isManualCompletion, earlyCompletionMs: Math.max(0, earlyCompletionMs)
            };

            state.pastTasks.unshift(completedTask);

            // *** FIX: Remove the task from currentTasks array IMMEDIATELY ***
            state.currentTasks.splice(taskIndex, 1);

            renderPastTasks(); // Update completed list display
            renderTasks(); // *** FIX: Re-render ongoing tasks list to remove the completed one ***

            if (isManualCompletion && earlyCompletionMs > 0) {
                showCelebration(task.name, earlyCompletionMs);
            }

            saveToLocalStorage(); // Save the updated state
            console.log("Task completed and removed:", taskId);
        }

        function showCelebration(taskName, earlyCompletionMs) { /* ... (same logic) ... */
            const s=Math.floor(earlyCompletionMs/1e3)%60, m=Math.floor(earlyCompletionMs/6e4)%60, h=Math.floor(earlyCompletionMs/36e5)%24, d=Math.floor(earlyCompletionMs/864e5); let p=[]; if(d>0)p.push(`${d}d`); if(h>0)p.push(`${h}h`); if(m>0)p.push(`${m}m`); if(s>0||p.length===0)p.push(`${s}s`); const eT=p.join(' '); celebrationText.textContent="CONGRATULATIONS!"; celebrationSubtext.textContent=`You completed "${taskName}" ${eT} early!`; celebrationOverlay.style.display='flex'; celebrationOverlay.classList.add('active'); createConfetti();
        }
        function createConfetti() { /* ... (same logic) ... */ const cont=celebrationOverlay; cont.querySelectorAll('.confetti').forEach(c=>c.remove()); const colors=['#f00','#0f0','#00f','#ff0','#f0f','#0ff','#fff']; const count=150; for(let i=0; i<count; i++){const c=document.createElement('div'); c.className='confetti'; c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)]; const sX=Math.random()*100, sY=-10-Math.random()*20, size=Math.random()*8+6; c.style.left=`${sX}%`; c.style.top=`${sY}px`; c.style.width=`${size}px`; c.style.height=`${size}px`; c.style.transform=`rotate(${Math.random()*360}deg)`; c.style.opacity='1'; cont.appendChild(c); const dur=Math.random()*3+3, fEX=sX+(Math.random()*200-100), rotE=Math.random()*720+360, fallD=Math.random()*0.5; requestAnimationFrame(()=>{c.style.transition=`transform ${dur}s linear ${fallD}s, top ${dur}s ease-in ${fallD}s, opacity ${dur*0.5}s ease-out ${dur*0.5+fallD}s`; c.style.top='110%'; c.style.transform=`translateX(${fEX-sX}px) rotate(${rotE}deg)`; c.style.opacity='0';}); setTimeout(()=>{c.remove();},(dur+fallD)*1e3+100);} }
        function renderPastTasks() { /* ... (same logic) ... */ pastTasksListEl.innerHTML=''; if(!state.pastTasks||state.pastTasks.length===0){pastTasksListEl.innerHTML='<div class="past-task-item no-tasks-message">No completed tasks yet</div>';return;} const sorted=state.pastTasks.sort((a,b)=>new Date(b.completedAt)-new Date(a.completedAt)); sorted.forEach(task=>{if(!task||typeof task.actualDurationMs!=='number')return; const el=document.createElement('div'); el.className='past-task-item'; const dur=task.actualDurationMs; let durTxt=formatDuration(Math.floor(dur/1e3)); const compDate=new Date(task.completedAt); if(isNaN(compDate))return; const compDateFmt=compDate.toLocaleString('en-US',{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); el.innerHTML=`<div style="flex-grow: 1; margin-right: 10px;"> <div class="past-task-name" title="${task.name}">‚úÖ ${task.name}</div> <div class="past-task-date">üìÖ Completed: ${compDateFmt}</div> ${task.isManualCompletion&&task.earlyCompletionMs>0?`<div class="early-completion">üéâ ${formatEarlyCompletion(task.earlyCompletionMs)} early!</div>`:''} </div> <div class="past-task-time" title="Actual duration">üïí ${durTxt}</div>`; pastTasksListEl.appendChild(el);}); }
        function formatEarlyCompletion(ms) { const s=Math.floor(ms/1e3)%60, m=Math.floor(ms/6e4)%60, h=Math.floor(ms/36e5)%24, d=Math.floor(ms/864e5); let p=[]; if(d>0)p.push(`${d}d`); if(h>0)p.push(`${h}h`); if(m>0)p.push(`${m}m`); if(s>0||p.length===0)p.push(`${s}s`); return p.join(' '); }
        function toggleTheme() { state.darkTheme=!state.darkTheme; document.body.classList.toggle('dark-theme'); saveToLocalStorage(); if(pomodoroStatusModal.style.display==='flex')updatePomodoroCharts(); if(focusStatusModal.style.display==='flex')updateFocusCharts(); createTimeRings(); /* Recreate rings for theme change */ }
        function toggleSettingsMenu(e) { e.stopPropagation(); settingsMenu.classList.toggle('active'); }
        function openDataModal() { dataTextarea.value=''; dataTextarea.style.display='none'; importConfirmBtn.style.display='none'; dataModal.style.display='flex'; }
        function closeDataModal() { dataModal.style.display='none'; }
        function exportAsJson() { /* ... (same logic) ... */ const data={currentTasks:state.currentTasks,pastTasks:state.pastTasks,darkTheme:state.darkTheme,buttonPositions:state.buttonPositions,pomodoro: { records: state.pomodoro.records, totalSeconds: state.pomodoro.totalSeconds }, focus: { records: state.focus.records }}; const jsonData=JSON.stringify(data,null,2); dataTextarea.value=jsonData; dataTextarea.style.display='block'; importConfirmBtn.style.display='none'; if(navigator.clipboard&&navigator.clipboard.writeText){navigator.clipboard.writeText(jsonData).then(()=>{const t=exportJsonBtn.textContent;exportJsonBtn.textContent='Copied!';setTimeout(()=>{exportJsonBtn.textContent=t;},2e3);}).catch(err=>{console.error('Async clipboard copy failed:',err);selectAndAlertCopy();});}else{selectAndAlertCopy();} }
        function selectAndAlertCopy() { /* ... (same helper) ... */ dataTextarea.select();dataTextarea.setSelectionRange(0,99999); try{const s=document.execCommand('copy'); const m=s?'Copied!':'Press Ctrl+C / Cmd+C'; const t=exportJsonBtn.textContent; exportJsonBtn.textContent=m; setTimeout(()=>{exportJsonBtn.textContent=t;},3e3);}catch(err){console.error('Fallback copy failed:',err);const t=exportJsonBtn.textContent;exportJsonBtn.textContent='Press Ctrl+C / Cmd+C';setTimeout(()=>{exportJsonBtn.textContent=t;},3e3);} }
        function showImportTextarea() { dataTextarea.value=''; dataTextarea.placeholder='Paste your JSON data here for import'; dataTextarea.style.display='block'; importConfirmBtn.style.display='block'; dataTextarea.focus(); }
        function importFromJson() { /* ... (same logic, ensure pomodoro totalSeconds is loaded) ... */
             const jsonData=dataTextarea.value.trim(); if(!jsonData){alert('Please paste JSON data first.');return;}
             try{ const data=JSON.parse(jsonData); if(typeof data!=='object'||data===null||!Array.isArray(data.currentTasks)||!Array.isArray(data.pastTasks)){throw new Error('Invalid data format.');}
                 if(confirm('Overwrite ALL current data?')){
                     state.currentTasks=data.currentTasks||[]; state.pastTasks=data.pastTasks||[]; state.darkTheme=data.darkTheme||false;
                     state.buttonPositions=data.buttonPositions||{themeToggle:{x:window.innerWidth-70,y:window.innerHeight-70},addTask:{x:window.innerWidth-70,y:window.innerHeight-130}};
                     state.pomodoro.records=Array.isArray(data.pomodoro?.records)?data.pomodoro.records:[]; // Load from nested object
                     state.focus.records=Array.isArray(data.focus?.records)?data.focus.records:[]; // Load from nested object
                     state.pomodoro.totalSeconds = (data.pomodoro && typeof data.pomodoro.totalSeconds === 'number') ? data.pomodoro.totalSeconds : 25 * 60; // Load saved duration
                     state.pomodoro.remainingSeconds = state.pomodoro.totalSeconds; // Reset remaining
                     state.pomodoro.isRunning=false;state.pomodoro.isPaused=false;clearInterval(state.pomodoro.timer);
                     state.focus.elapsedSeconds = 0; // Reset focus elapsed time
                     state.focus.isRunning=false;state.focus.isPaused=false;clearInterval(state.focus.timer);
                     document.body.classList.toggle('dark-theme',state.darkTheme);
                     requestAnimationFrame(()=>{positionButton(themeToggleBtn,state.buttonPositions.themeToggle);positionButton(addTaskBtn,state.buttonPositions.addTask);});
                     renderTasks(); renderPastTasks(); renderPomodoroRecords(); renderFocusRecords(); updatePomodoroDisplay(); updateFocusDisplay(); resetTimerButtons();
                     saveToLocalStorage(); closeDataModal(); alert('Data imported successfully!');
                 }
             } catch(error){ console.error("Import Error:",error); alert('Error importing data: '+error.message); }
        }
        function resetTimerButtons() { /* ... (same helper) ... */ startPomodoroBtn.style.display='inline-block'; pausePomodoroBtn.disabled=true; pausePomodoroBtn.textContent='Pause'; cancelPomodoroBtn.disabled=true; startFocusBtn.disabled=false; pauseFocusBtn.disabled=true; pauseFocusBtn.textContent='Pause'; stopFocusBtn.disabled=true; focusTaskInput.style.display='block'; focusTaskName.value=''; }

        // *** CORRECTED saveToLocalStorage Function ***
        function saveToLocalStorage() {
            try {
                 const dataToSave = {
                     // Spread the entire state first
                     ...state,
                     // Explicitly define keys to override or exclude transient parts
                     pomodoro: {
                         // Keep records and settings
                         records: state.pomodoro.records,
                         totalSeconds: state.pomodoro.totalSeconds,
                         // Exclude active state
                         timer: null,
                         isRunning: false,
                         isPaused: false,
                         remainingSeconds: state.pomodoro.totalSeconds, // Save total as remaining for next load
                         startTime: null,
                         endTime: null,
                         currentRecord: null
                     },
                     focus: {
                         // Keep records
                         records: state.focus.records,
                         // Exclude active state
                         timer: null,
                         isRunning: false,
                         isPaused: false,
                         elapsedSeconds: 0, // Reset elapsed on save/load
                         startTime: null,
                         endTime: null,
                         currentRecord: null
                     }
                 };
                localStorage.setItem('productivitySuite', JSON.stringify(dataToSave));
                 // console.log("Data saved to localStorage."); // Optional: for debugging
            } catch (error) {
                 console.error("Error saving to localStorage:", error);
            }
        }

        function loadFromLocalStorage() { /* ... (same logic, ensure pomodoro.totalSeconds is loaded) ... */
             const saved=localStorage.getItem('productivitySuite'); if(!saved){return;}
             try{ const data=JSON.parse(saved);
                 state.currentTasks=Array.isArray(data.currentTasks)?data.currentTasks:[];
                 state.pastTasks=Array.isArray(data.pastTasks)?data.pastTasks:[];
                 state.darkTheme=typeof data.darkTheme==='boolean'?data.darkTheme:false;
                 state.buttonPositions=(data.buttonPositions&&typeof data.buttonPositions.themeToggle?.x==='number')?data.buttonPositions:{themeToggle:{x:window.innerWidth-70,y:window.innerHeight-70},addTask:{x:window.innerWidth-70,y:window.innerHeight-130}};
                 // Load records from nested structure
                 state.pomodoro.records=Array.isArray(data.pomodoro?.records)?data.pomodoro.records:[];
                 state.focus.records=Array.isArray(data.focus?.records)?data.focus.records:[];
                 // Load saved Pomodoro duration
                 state.pomodoro.totalSeconds=(data.pomodoro&&typeof data.pomodoro.totalSeconds==='number')?data.pomodoro.totalSeconds:25*60;
                 state.pomodoro.remainingSeconds=state.pomodoro.totalSeconds; // Reset remaining time
                 state.focus.elapsedSeconds=0; // Reset focus timer
                 console.log("Data loaded.");
             }catch(error){console.error('Error parsing localStorage:',error); localStorage.removeItem('productivitySuite');}
         }

        // --- Pomodoro Timer Functions ---
        function updatePomodoroDisplay() { /* ... same logic ... */ const m=Math.floor(state.pomodoro.remainingSeconds/60),s=state.pomodoro.remainingSeconds%60; pomodoroTimeEl.textContent=`${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; const ind=document.getElementById('pomodoro-progress-indicator'); if(ind){const circ=578, tot=state.pomodoro.totalSeconds, prog=tot>0?((tot-state.pomodoro.remainingSeconds)/tot)*100:0, off=circ*(1-prog/100); ind.style.strokeDashoffset=Math.max(0,Math.min(circ,off));} }
        function startPomodoro() { /* ... same logic ... */ if(state.pomodoro.isRunning)return; state.pomodoro.isRunning=true; state.pomodoro.isPaused=false; const now=new Date(); state.pomodoro.startTime=now.toISOString(); state.pomodoro.remainingSeconds=state.pomodoro.totalSeconds; updatePomodoroDisplay(); state.pomodoro.currentRecord={id:Date.now(),startTime:state.pomodoro.startTime,status:'running',pauses:0,remark:null,duration:0}; startPomodoroBtn.style.display='none'; pausePomodoroBtn.disabled=false; pausePomodoroBtn.textContent='Pause'; cancelPomodoroBtn.disabled=false; state.pomodoro.timer=setInterval(()=>{state.pomodoro.remainingSeconds--;updatePomodoroDisplay();if(state.pomodoro.remainingSeconds<=0)completePomodoro();},1e3); document.title="Pomodoro Running! üçÖ"; }
        function togglePausePomodoro() { /* ... same logic ... */ if(!state.pomodoro.isRunning)return; if(state.pomodoro.isPaused){state.pomodoro.isPaused=false; pausePomodoroBtn.textContent='Pause'; state.pomodoro.timer=setInterval(()=>{state.pomodoro.remainingSeconds--;updatePomodoroDisplay();if(state.pomodoro.remainingSeconds<=0)completePomodoro();},1e3); document.title="Pomodoro Running! üçÖ";}else{state.pomodoro.isPaused=true; pausePomodoroBtn.textContent='Resume'; clearInterval(state.pomodoro.timer); if(state.pomodoro.currentRecord)state.pomodoro.currentRecord.pauses++; document.title="Pomodoro Paused ||";} }
        function cancelPomodoro() { /* ... same logic ... */ clearInterval(state.pomodoro.timer); const wasRunning=state.pomodoro.isRunning; state.pomodoro.isRunning=false;state.pomodoro.isPaused=false; startPomodoroBtn.style.display='inline-block'; pausePomodoroBtn.disabled=true; pausePomodoroBtn.textContent='Pause'; cancelPomodoroBtn.disabled=true; document.title="Productivity Suite"; if(state.pomodoro.currentRecord&&wasRunning){state.pomodoro.currentRecord.endTime=new Date().toISOString();state.pomodoro.currentRecord.status='cancelled';state.pomodoro.currentRecord.duration=state.pomodoro.totalSeconds-state.pomodoro.remainingSeconds;openPomodoroRemarksModal();}else{state.pomodoro.currentRecord=null;} state.pomodoro.remainingSeconds=state.pomodoro.totalSeconds; updatePomodoroDisplay(); }
        function completePomodoro() { /* ... same logic ... */ clearInterval(state.pomodoro.timer); const wasRunning=state.pomodoro.isRunning; state.pomodoro.isRunning=false;state.pomodoro.isPaused=false; startPomodoroBtn.style.display='inline-block'; pausePomodoroBtn.disabled=true; pausePomodoroBtn.textContent='Pause'; cancelPomodoroBtn.disabled=true; document.title="Pomodoro Finished! üéâ"; if(state.pomodoro.currentRecord&&wasRunning){state.pomodoro.currentRecord.endTime=new Date().toISOString();state.pomodoro.currentRecord.status=(state.pomodoro.currentRecord.pauses>0)?'paused':'completed';state.pomodoro.currentRecord.duration=state.pomodoro.totalSeconds;openPomodoroRemarksModal();}else{state.pomodoro.currentRecord=null;} state.pomodoro.remainingSeconds=state.pomodoro.totalSeconds; updatePomodoroDisplay(); }
        function openPomodoroSetModal() { /* ... same logic ... */ const cM=Math.floor(state.pomodoro.totalSeconds/60), cH=Math.floor(cM/60), cMin=cM%60; pomodoroHoursInput.value=cH; pomodoroMinutesInput.value=cMin; pomodoroTimeSlider.value=cM; pomodoroTimeSlider.max=1559; pomodoroSetModal.style.display='flex'; requestAnimationFrame(()=>pomodoroMinutesInput.focus()); }
        function closePomodoroSetModalFunc() { pomodoroSetModal.style.display = 'none'; }
        function savePomodoroTime() { /* ... same logic ... */ const h=parseInt(pomodoroHoursInput.value)||0, m=parseInt(pomodoroMinutesInput.value)||0; if(h<0||h>25||m<0||m>59||(h===0&&m===0)||(h===25&&m>59)){alert('Time must be between 1 minute and 25h 59m.');return;} const totM=(h*60)+m; state.pomodoro.totalSeconds=totM*60; state.pomodoro.remainingSeconds=state.pomodoro.totalSeconds; updatePomodoroDisplay(); saveToLocalStorage(); closePomodoroSetModalFunc(); }
        function updatePomodoroTimeFromSlider() { /* ... same logic ... */ const tM=parseInt(pomodoroTimeSlider.value); pomodoroHoursInput.value=Math.floor(tM/60); pomodoroMinutesInput.value=tM%60; }
        function updatePomodoroTimeFromInputs() { /* ... same logic ... */ let h=parseInt(pomodoroHoursInput.value)||0, m=parseInt(pomodoroMinutesInput.value)||0; h=Math.max(0,Math.min(h,25)); m=Math.max(0,Math.min(m,59)); if(h===25)m=Math.min(m,59); pomodoroHoursInput.value=h; pomodoroMinutesInput.value=m; pomodoroTimeSlider.value=(h*60)+m; }
        function openPomodoroRemarksModal() { /* ... same logic ... */ pomodoroRemarksModal.querySelectorAll('.remarks-option').forEach(o=>o.classList.remove('selected')); pomodoroRemarksModal.style.display='flex'; }
        function closePomodoroRemarksModalFunc() { /* ... same logic ... */ pomodoroRemarksModal.style.display='none'; if(state.pomodoro.currentRecord&&!state.pomodoro.records.some(r=>r.id===state.pomodoro.currentRecord.id)){state.pomodoro.currentRecord.remark=null;state.pomodoro.records.unshift(state.pomodoro.currentRecord);renderPomodoroRecords();saveToLocalStorage();state.pomodoro.currentRecord=null;} document.title="Productivity Suite"; }
        function savePomodoroRemarks() { /* ... same logic ... */ if(!state.pomodoro.currentRecord){closePomodoroRemarksModalFunc();return;} const sel=pomodoroRemarksModal.querySelector('.remarks-option.selected'); state.pomodoro.currentRecord.remark=sel?sel.getAttribute('data-remark'):null; state.pomodoro.records.unshift(state.pomodoro.currentRecord); renderPomodoroRecords(); saveToLocalStorage(); state.pomodoro.currentRecord=null; closePomodoroRemarksModalFunc(); }
        function renderPomodoroRecords() { /* ... same logic ... */ pomodoroRecordsBody.innerHTML=''; if(!state.pomodoro.records||state.pomodoro.records.length===0){pomodoroRecordsBody.innerHTML='<tr><td colspan="5" class="no-tasks-message">No records yet</td></tr>';return;} const sorted=state.pomodoro.records.sort((a,b)=>new Date(b.startTime)-new Date(a.startTime)); sorted.forEach(rec=>{if(!rec||!rec.startTime)return; const row=document.createElement('tr'); const map={completed:'‚úÖ',paused:'‚è∏Ô∏è',cancelled:'‚ùå',running:'‚è≥'}; row.innerHTML=`<td title="${rec.status}">${map[rec.status]||'?'}</td><td>${formatDateTime(new Date(rec.startTime))}</td><td>${rec.endTime?formatDateTime(new Date(rec.endTime)):'--'}</td><td>${(typeof rec.duration==='number')?formatDuration(rec.duration):'--'}</td><td>${rec.remark||'--'}</td>`; pomodoroRecordsBody.appendChild(row);}); }
        function openPomodoroStatusModal() { /* ... same logic ... */ switchStatusView('pomodoro-daily', pomodoroStatusTabs, pomodoroViews); updatePomodoroCharts(); pomodoroStatusModal.style.display='flex'; }
        function closePomodoroStatusModalFunc() { pomodoroStatusModal.style.display='none'; }

        // --- Focus Timer Functions ---
        function updateFocusDisplay() { /* ... same logic ... */ const h=Math.floor(state.focus.elapsedSeconds/3600),m=Math.floor((state.focus.elapsedSeconds%3600)/60),s=state.focus.elapsedSeconds%60; focusTimeDisplay.textContent=`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; }
        function startFocus() { /* ... same logic ... */ if(state.focus.isRunning)return; const taskName=focusTaskName.value.trim(); if(!taskName){alert('Please enter focus task.');focusTaskName.focus();return;} state.focus.isRunning=true;state.focus.isPaused=false; const now=new Date(); state.focus.startTime=now.toISOString(); state.focus.elapsedSeconds=0; state.focus.currentRecord={id:Date.now(),task:taskName,startTime:state.focus.startTime,status:'running',pauses:0,remark:null,duration:0}; startFocusBtn.disabled=true; pauseFocusBtn.disabled=false; pauseFocusBtn.textContent='Pause'; stopFocusBtn.disabled=false; focusTaskInput.style.display='none'; state.focus.timer=setInterval(()=>{state.focus.elapsedSeconds++;updateFocusDisplay(); document.title=`Focusing: ${focusTimeDisplay.textContent}`;},1e3); }
        function togglePauseFocus() { /* ... same logic ... */ if(!state.focus.isRunning)return; if(state.focus.isPaused){state.focus.isPaused=false; pauseFocusBtn.textContent='Pause'; state.focus.timer=setInterval(()=>{state.focus.elapsedSeconds++;updateFocusDisplay(); document.title=`Focusing: ${focusTimeDisplay.textContent}`;},1e3);}else{state.focus.isPaused=true; pauseFocusBtn.textContent='Resume'; clearInterval(state.focus.timer); if(state.focus.currentRecord)state.focus.currentRecord.pauses++; document.title=`Focus Paused ||`;} }
        function stopFocus() { /* ... same logic ... */ clearInterval(state.focus.timer); const wasRunning=state.focus.isRunning; state.focus.isRunning=false;state.focus.isPaused=false; startFocusBtn.disabled=false; pauseFocusBtn.disabled=true; pauseFocusBtn.textContent='Pause'; stopFocusBtn.disabled=true; focusTaskInput.style.display='block'; focusTaskName.value=''; document.title="Productivity Suite"; if(state.focus.currentRecord&&wasRunning){state.focus.currentRecord.endTime=new Date().toISOString();state.focus.currentRecord.status=(state.focus.currentRecord.pauses>0)?'paused':'completed';state.focus.currentRecord.duration=state.focus.elapsedSeconds;openFocusRemarksModal();}else{state.focus.currentRecord=null;} state.focus.elapsedSeconds=0; updateFocusDisplay(); }
        function openFocusRemarksModal() { /* ... same logic ... */ focusRemarksModal.querySelectorAll('.remarks-option').forEach(o=>o.classList.remove('selected')); focusRemarksModal.style.display='flex'; }
        function closeFocusRemarksModalFunc() { /* ... same logic ... */ focusRemarksModal.style.display='none'; if(state.focus.currentRecord&&!state.focus.records.some(r=>r.id===state.focus.currentRecord.id)){state.focus.currentRecord.remark=null;state.focus.records.unshift(state.focus.currentRecord);renderFocusRecords();saveToLocalStorage();state.focus.currentRecord=null;} document.title="Productivity Suite"; }
        function saveFocusRemarks() { /* ... same logic ... */ if(!state.focus.currentRecord){closeFocusRemarksModalFunc();return;} const sel=focusRemarksModal.querySelector('.remarks-option.selected'); state.focus.currentRecord.remark=sel?sel.getAttribute('data-remark'):null; state.focus.records.unshift(state.focus.currentRecord); renderFocusRecords(); saveToLocalStorage(); state.focus.currentRecord=null; closeFocusRemarksModalFunc(); }
        function renderFocusRecords() { /* ... same logic ... */ focusRecordsBody.innerHTML=''; if(!state.focus.records||state.focus.records.length===0){focusRecordsBody.innerHTML='<tr><td colspan="5" class="no-tasks-message">No records yet</td></tr>';return;} const sorted=state.focus.records.sort((a,b)=>new Date(b.startTime)-new Date(a.startTime)); sorted.forEach(rec=>{if(!rec||!rec.startTime)return; const row=document.createElement('tr'); const map={completed:'‚úÖ',paused:'‚è∏Ô∏è',running:'‚è≥'}; row.innerHTML=`<td title="${rec.status}">${map[rec.status]||'?'}</td><td>${formatDate(new Date(rec.startTime))}</td><td>${(typeof rec.duration==='number')?formatDuration(rec.duration):'--'}</td><td>${rec.task||'--'}</td><td>${rec.remark||'--'}</td>`; focusRecordsBody.appendChild(row);}); }
        function openFocusStatusModal() { /* ... same logic ... */ switchStatusView('focus-daily', focusStatusTabs, focusViews); updateFocusCharts(); focusStatusModal.style.display='flex'; }
        function closeFocusStatusModalFunc() { focusStatusModal.style.display='none'; }

        // --- Charting & Status Functions ---
        function switchStatusView(viewId, tabElements, viewElements) { /* ... same logic ... */ tabElements.forEach(tab=>{tab.classList.toggle('active',tab.getAttribute('data-view')===viewId);}); viewElements.forEach(view=>{const id=viewId.split('-').slice(1).join('-'); view.classList.toggle('active',view.id.startsWith(id)||view.id.startsWith(viewId));}); }
        function getAndValidateDateRange(startInput, endInput) { /* ... same logic ... */ let sStr=startInput.value, eStr=endInput.value; const today=new Date(), todayStr=formatDateForInput(today); if(!sStr){const wA=new Date(); wA.setDate(today.getDate()-7); sStr=formatDateForInput(wA); startInput.value=sStr;} if(!eStr){eStr=todayStr; endInput.value=eStr;} const sD=new Date(sStr); sD.setHours(0,0,0,0); let eD=new Date(eStr); eD.setHours(23,59,59,999); if(isNaN(sD)||isNaN(eD)||sD>eD){alert("Invalid date range."); return{};} if(eD>today){eD=today; eD.setHours(23,59,59,999); eStr=todayStr; endInput.value=todayStr;} startInput.max=eStr; endInput.min=sStr; return{startDate:sD, endDate:eD, startDateStr:sStr, endDateStr:eStr}; }
        function updatePomodoroCharts() { /* ... same logic ... */ const{startDate,endDate,startDateStr,endDateStr}=getAndValidateDateRange(pomodoroStartDate,pomodoroEndDate); if(!startDate)return; const filtRec=state.pomodoro.records.filter(r=>{if(!r||!r.startTime)return false;const d=new Date(r.startTime);return!isNaN(d)&&d>=startDate&&d<=endDate;}); renderDailyOverviewChart(pomodoroDailyChart,filtRec,startDateStr,endDateStr,'Pomodoro'); renderRemarksBreakdownChart(pomodoroRemarksChart,filtRec,startDateStr,endDateStr,'var(--pomodoro-color)'); }
        function updateFocusCharts() { /* ... same logic ... */ const{startDate,endDate,startDateStr,endDateStr}=getAndValidateDateRange(focusStartDate,focusEndDate); if(!startDate)return; const filtRec=state.focus.records.filter(r=>{if(!r||!r.startTime)return false;const d=new Date(r.startTime);return!isNaN(d)&&d>=startDate&&d<=endDate;}); renderDailyOverviewChart(focusDailyChart,filtRec,startDateStr,endDateStr,'Focus'); renderRemarksBreakdownChart(focusRemarksChart,filtRec,startDateStr,endDateStr,'var(--focus-color)'); }
        function renderDailyOverviewChart(chartEl, records, sDate, eDate, type) { /* ... same logic ... */ const daily={}; records.forEach(r=>{const dtStr=new Date(r.startTime).toLocaleDateString('en-CA'); if(!daily[dtStr])daily[dtStr]={totalTime:0,sessions:0,completed:0,paused:0,cancelled:0,tasks:new Set()}; const dur=typeof r.duration==='number'?r.duration:0; daily[dtStr].totalTime+=dur; daily[dtStr].sessions++; if(r.status==='completed')daily[dtStr].completed++; else if(r.status==='paused')daily[dtStr].paused++; else if(r.status==='cancelled')daily[dtStr].cancelled++; if(r.task)daily[dtStr].tasks.add(r.task);}); const dates=Object.keys(daily).sort(); let totMin=0, totSess=0, totComp=0, totCanc=0; let uniqueTasks=new Set(); let html=`<h4>Daily ${type} Overview (${sDate} to ${eDate})</h4>`; if(dates.length===0){html+=`<p class="no-tasks-message">No sessions found.</p>`;}else{dates.forEach(d=>{const day=daily[d]; totMin+=day.totalTime; totSess+=day.sessions; totComp+=(day.completed+day.paused); totCanc+=day.cancelled; if(type==='Focus')day.tasks.forEach(t=>uniqueTasks.add(t));}); html+=`<p>Total Time: ${formatDuration(totMin)}</p><p>Total Sessions: ${totSess}</p><p>Completed/Paused: ${totComp}</p><p>Cancelled: ${totCanc}</p>`; if(type==='Focus')html+=`<p>Unique Tasks: ${uniqueTasks.size}</p>`; html+=`<div style="margin-top:15px;max-height:150px;overflow-y:auto;font-size:0.9rem;">`; dates.forEach(d=>{html+=`<div style="border-bottom:1px dashed var(--progress-bg);padding:3px 0;">${formatDate(new Date(d))}: ${formatDuration(daily[d].totalTime)} (${daily[d].sessions} sessions)</div>`;}); html+=`</div>`;} chartEl.innerHTML=html; }
        function renderRemarksBreakdownChart(chartEl, records, sDate, eDate, barColor) { /* ... same logic ... */ const remarks={}; let total=0; records.forEach(r=>{if(r.remark){remarks[r.remark]=(remarks[r.remark]||0)+1; total++;}}); let html=`<h4>Remarks Breakdown (${sDate} to ${eDate})</h4>`; if(total===0){html+=`<p class="no-tasks-message">No remarks found.</p>`;}else{const sorted=Object.entries(remarks).sort(([,a],[,b])=>b-a); html+=`<p>Total Remarks: ${total}</p><div style="margin-top:10px;">`; sorted.forEach(([rem,cnt])=>{const perc=Math.round((cnt/total)*100); html+=`<div style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;margin-bottom:3px;font-size:0.9rem;"><span>${rem} (${cnt})</span><span>${perc}%</span></div><div style="height:10px;background-color:var(--progress-bg);border-radius:5px;overflow:hidden;"><div style="width:${perc}%;height:100%;background-color:${barColor};border-radius:5px;"></div></div></div>`;}); html+=`</div>`;} chartEl.innerHTML=html; }

        // --- Utility Functions ---
        function formatDate(date) { if(!(date instanceof Date))date=new Date(date); if(isNaN(date))return'--'; return date.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});}
        function formatDateTime(date) { if(!(date instanceof Date))date=new Date(date); if(isNaN(date))return'--'; return date.toLocaleString('en-US',{hour:'2-digit',minute:'2-digit',month:'short',day:'numeric',year:'numeric'});}
        function formatDuration(secs) { if(typeof secs!=='number'||secs<0)return'--'; if(secs===0)return'0s'; const h=Math.floor(secs/3600),m=Math.floor((secs%3600)/60),s=secs%60; let p=[]; if(h>0)p.push(`${h}h`); if(m>0)p.push(`${m}m`); if(s>0||p.length===0)p.push(`${s}s`); return p.join(' ');}
        function formatDateForInput(date) { if(!(date instanceof Date)||isNaN(date))return''; const y=date.getFullYear(),M=String(date.getMonth()+1).padStart(2,'0'),D=String(date.getDate()).padStart(2,'0'); return`${y}-${M}-${D}`; }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>